name: Test nvim-java Plugin

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:
    inputs:
      nvim_java_test_branch:
        description: 'nvim-java-test branch'
        required: false
        type: string
      mason_nvim_branch:
        description: 'mason.nvim branch'
        required: false
        type: string
      nvim_java_core_branch:
        description: 'nvim-java-core branch'
        required: false
        type: string
      lua_async_await_branch:
        description: 'lua-async-await branch'
        required: false
        type: string
      nvim_java_refactor_branch:
        description: 'nvim-java-refactor branch'
        required: false
        type: string
      nvim_java_dap_branch:
        description: 'nvim-java-dap branch'
        required: false
        type: string
      nui_nvim_branch:
        description: 'nui.nvim branch'
        required: false
        type: string
      nvim_lspconfig_branch:
        description: 'nvim-lspconfig branch'
        required: false
        type: string
      nvim_dap_branch:
        description: 'nvim-dap branch'
        required: false
        type: string
      spring_boot_nvim_branch:
        description: 'spring-boot.nvim branch'
        required: false
        type: string
      nvim_java_branch:
        description: 'nvim-java branch'
        required: false
        type: string

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      LUA_ASYNC_AWAIT_BRANCH: ${{ inputs.lua_async_await_branch }}
      MASON_NVIM_BRANCH: ${{ inputs.mason_nvim_branch }}
      NUI_NVIM_BRANCH: ${{ inputs.nui_nvim_branch }}
      NVIM_DAP_BRANCH: ${{ inputs.nvim_dap_branch }}
      NVIM_JAVA_BRANCH: ${{ inputs.nvim_java_branch }}
      NVIM_JAVA_CORE_BRANCH: ${{ inputs.nvim_java_core_branch }}
      NVIM_JAVA_DAP_BRANCH: ${{ inputs.nvim_java_dap_branch }}
      NVIM_JAVA_REFACTOR_BRANCH: ${{ inputs.nvim_java_refactor_branch }}
      NVIM_JAVA_TEST_BRANCH: ${{ inputs.nvim_java_test_branch }}
      NVIM_LSPCONFIG_BRANCH: ${{ inputs.nvim_lspconfig_branch }}
      SPRING_BOOT_NVIM_BRANCH: ${{ inputs.spring_boot_nvim_branch }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
    
    - name: Setup Neovim
      uses: rhysd/action-setup-vim@v1
      with:
        neovim: true
        version: nightly
    
    - name: Setup neovim config
      run: |
        mkdir -p ~/.config/nvim
        cp nvim-config/init.lua ~/.config/nvim/init.lua
        
    - name: Install plenary.nvim for testing
      run: |
        mkdir -p ~/.local/share/nvim/site/pack/deps/start/plenary.nvim
        git clone https://github.com/nvim-lua/plenary.nvim ~/.local/share/nvim/site/pack/deps/start/plenary.nvim
    
    - name: Wait for Mason packages to install
      run: |
        nvim --headless -c "set runtimepath+=$(pwd)" -c "lua require('utils.utils').wait_for_mason_install()" -c "qa!"
    
    - name: Run tests
      run: |
        nvim --headless -c "lua require('plenary.test_harness').test_directory('tests')" -c "qa!"
